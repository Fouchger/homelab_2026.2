---
# -----------------------------------------------------------------------------
# Role: admin_node
# Created: 2026-01-18
# Description: Admin node tooling (Docker, code-server, IaC tooling).
# Developer notes:
# - This role assumes Ubuntu/Debian.
# - The admin node is privileged Docker-capable LXC.
# -----------------------------------------------------------------------------

- name: Install Docker dependencies
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present

- name: Add Docker GPG key
  ansible.builtin.shell: |
    set -e
    install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg
  args:
    creates: /etc/apt/keyrings/docker.gpg

- name: Add Docker repository
  ansible.builtin.shell: |
    set -e
    ARCH=$(dpkg --print-architecture)
    CODENAME=$(. /etc/os-release && echo "$VERSION_CODENAME")
    echo "deb [arch=${ARCH} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu ${CODENAME} stable" > /etc/apt/sources.list.d/docker.list
  args:
    creates: /etc/apt/sources.list.d/docker.list

- name: Install Docker Engine
  ansible.builtin.apt:
    update_cache: true
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present

- name: Ensure Docker service is enabled
  ansible.builtin.systemd:
    name: docker
    enabled: true
    state: started

- name: Install code-server
  ansible.builtin.shell: |
    set -e
    curl -fsSL https://code-server.dev/install.sh | sh
  args:
    creates: /usr/bin/code-server

- name: Create code-server systemd unit
  ansible.builtin.copy:
    dest: /etc/systemd/system/code-server.service
    mode: "0644"
    content: |
      [Unit]
      Description=code-server
      After=network.target

      [Service]
      Type=simple
      User=root
      Environment=PASSWORD=
      ExecStart=/usr/bin/code-server --bind-addr 0.0.0.0:8080 --auth none
      Restart=always
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

- name: Enable and start code-server
  ansible.builtin.systemd:
    name: code-server
    daemon_reload: true
    enabled: true
    state: started
